{% extends "base.html" %}

{% load bootstrap_tags %}
{% load phone_number_filter %}

{% block title %}Home{% endblock title %}

{% block content %}
  <h1>Call Tracking with Django</h1>

  <p>This app shows you how to implement a sample call tracking application with Python and Django. Add a new phone number below to get started.</p>

  <div class="row">

    <div class="col-md-6">

      <h2>Add a new number</h2>
      <p>Create a new lead source by purchasing a new phone number. Area code is optional.</p>

      <form class="form-inline" method="post" action="/call-tracking/list-numbers">
        {% csrf_token %}
        {{ form|as_bootstrap_inline }}
        <div class="form-group">
          <div class="col-sm-offset-2 col-sm-10">
            <button type="submit" class="btn btn-primary">Search</button>
          </div>
        </div>
      </form>

      <br />

      <h2>Lead sources</h2>
      <p>These are the lead sources currently in the system. Call one and refresh the page to see the charts update.</p>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Name</th>
            <th>Incoming number</th>
            <th>Forwarding number</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for lead_source in lead_sources %}
            <tr>
              <td>{{ lead_source.name }}</td>
              <td>{{ lead_source.incoming_number.as_national }}</td>
              <td>{{ lead_source.forwarding_number.as_national|default:"(not set)" }}</td>
              <td>
                <a class="btn btn-default btn-xs" href="{% url 'edit_lead_source' lead_source.pk %}">Edit</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    </div><!--/col-md-8-->

    <div class="col-md-6">
      <div class="row">
        <div class="col-md-12">
          <h2>Charts</h2>
          <p>The latest statistics about how the lead sources are performing.</p>

          <h3>Calls by lead source</h3>
          <canvas id="leadsBySource"></canvas>

          <h3>Calls by city</h3>
          <canvas id="leadsByCity"></canvas>
        </div>
      </div>
    </div>

  </div><!--/row-->
{% endblock %}

{% block page_js %}
  <script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.js"></script>

  <script>
    // Make all charts responsive
    Chart.defaults.global.responsive = true;

    // Configure the leadsBySource bar chart
    $.get("/call-tracking/leads-by-source", function(data) {
      var ctx = document.getElementById("leadsBySource").getContext("2d");
      var data = {
            labels: data.sources,
            datasets: [
                {
                    label: "Leads by source",
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "rgba(151,187,205,0.8)",
                    highlightFill: "rgba(151,187,205,0.75)",
                    highlightStroke: "rgba(151,187,205,1)",
                    data: data.lead_counts
                }
            ]
        };
      var leadsBySource = new Chart(ctx).Bar(data);
    });

    // Configure the leadsByCity bar chart
    $.get("/call-tracking/leads-by-city", function(data) {
      var ctx = document.getElementById("leadsByCity").getContext("2d");
      var data = {
            labels: data.cities,
            datasets: [
                {
                    label: "Leads by city",
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "rgba(151,187,205,0.8)",
                    highlightFill: "rgba(151,187,205,0.75)",
                    highlightStroke: "rgba(151,187,205,1)",
                    data: data.lead_counts
                }
            ]
        };
      var leadsByCity = new Chart(ctx).Bar(data);
    });
  </script>
{% endblock %}
